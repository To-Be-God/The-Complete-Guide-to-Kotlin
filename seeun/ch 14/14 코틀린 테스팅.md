# 14 코틀린 테스팅

## 14.3 픽스처와 설정

### 14.3.1 픽스처 제공하기

- 실제 테스트를 진행하기 위해 필요한 환경과 자원을 초기화하고 테스트가 끝나면 정리해야 하는 경우가 있다. 이런 경우를 테스트 픽스처라 한다.
- 코테스트에서는 TestListener 인터페이스를 구현해 픽스처를 지정할 수 있다. TestListener 인터페이스는 BeforeTestListener 등의 개별 픽스처 인터페이스를 한데 모아둔 리스너다.
- beforeSpec()과 beforeTest()의 차이는 beforeTest()는 테스트마다 실행되고 테스트가 활성화된 경우에만 호출되는 반면에 beforeSpec()은 어떤 명세가 인스턴스화될 때 실행된다는 점이다.
    - 테스트 함수가 실제 호출될 때 불려야 하는 준비/정리 코드는 beforeTest()/afterTest()를 쓴다.
    - 명세 클래스의 인스턴스마다 하나씩 필요한 준비/정리 코드는 beforeSpec()/afterSpec()을 사용해야 한다.
- TestListener 에 정의된 prepareSpec과 finalizeSpec은 개별 Spec 안에서 listeners를 오버라이드하는 경우 정상 작동하지 않는다.
- 프로젝트(테스트를 실행할 때 모든 스펙 클래스가 모인 전체 테스트 모임) 수준의 리스너인 beforeProject()/afterProject() 구현을 제공하고 싶다면 ProjectConfig 타입의 싱글턴 객체에 리스너를 등록해야 한다.
- AutoCloseable 인터페이스를 구현한 자원을 자동으로 해제하기 위해선 자원을 할당할 때 autoClose() 호출로 자원을 감싸야 한다.

### 14.3.2 테스트 설정

- 코테스트는 테스트 환경을 설정할 수 있는 여러 가지 수단을 제공한다. 특히 명세 함수가 제공하는 config() 함수를 통해 여러 가지 테스트 실행 파라미터를 지정할 수 있다.
- config() 함수는 일반적으로 config()가 적용된 테스트 블록의 동작을 변경한다.
- config() 함수를 사용해 조정할 수 있는 파라미터는 다음과 같다.
    - invocations : 테스트 실행 횟수, 모든 실행이 성공해야 테스트가 성공한 것으로 간주한다. 간헐적으로 실패하는 비결정적 테스트가 있을 때 이런 옵션이 유용하다.
    - threads : 테스트를 실행할 스레드 개수, invocations가 2 이상일 때만 이 옵션이 유용하다. 실행 횟수가 1이라면 병렬화할 여지가 없다.
        - threads 옵션은 한 테스트 케이스에 속한 개별 테스트를 병렬화할 때만 영향을 미친다. 여러 테스트 케이스를 병렬로 실행하고 싶다면 AbstractProjectConfig를 사용해야 한다.
    - enabled :  테스트를 실행해야 할지 여부, false로 설정하면 테스트 실행을 비활성화한다.
    - timeout : 테스트 실행에 걸리는 최대 시간, 테스트 실행 시간이 이 타임아웃 값을 넘어서면 테스트가 종료되고 실패로 간주된다. 실행 횟수 옵션과 마찬가지로 이 옵션도 비결정적 테스트에서 유용하다.
- defaultConfig() 함수를 오버라이드해서 한 명세에 속한 모든 테스트 케이스의 설정을 한꺼번에 변경할 수도 있다.
- 코테스트는 테스트 사이에 테스트 케이스 인스턴스를 공유하는 방법을 지정할 수 있다. 이를 격리 모드라고 부른다.
    - 이 기능을 사용하기 위해서는 isolationMode 프로퍼티를 오버라이드해야 한다.
    - SingleInstance : 테스트 케이스의 인스턴스가 하나만 만들어진다. 이 옵션이 디폴트 동작이다.
    - InstancePerTest : 문맥이나 테스트 블록이 실행될 때마다 테스트 케이스의 새 인스턴스를 만든다.
    - InstancePerLeaf : 개별 테스트 블록을 실행하기 전에 테스트가 인스턴스화 된다.